# æ¨é€åˆ°pypi
name: release_to pypi

on:
  push:
    branches:
      - 'main'

jobs:
  release_to:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v2
        with:
          python-version: 3.11.0
          cache: pip

      # è¯»å–setup.py setupæ–¹æ³•çš„ç‰ˆæœ¬å·
      - name: Get version

        id: get_version
        run: |
          echo "version=$(python setup.py --version)" >> "$GITHUB_OUTPUT"

      # è·å–pypiçš„è¯¥é¡¹ç›®çš„ç‰ˆæœ¬å·
      - name: Get pypi version
        id: get_pypi_version
        run: |
          echo "version=$(curl -s https://pypi.org/pypi/music-tool-kit/json | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")" >> "$GITHUB_OUTPUT"

      # å¦‚æœversionå’Œcurr_versionç›¸åŒé€€å‡ºå·¥ä½œæµ
      # - name: Check version
      #   env:
      #     version: ${{ steps.get_version.outputs.version }}
      #     curr_version: ${{ steps.get_pypi_version.outputs.version }}
      #   run: |
      #     if [ $version == $curr_version ]; then
      #       echo "version is same, exit"
      #       exit 1
      #     fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine

      # - name: Build and publish
      #   continue-on-error: true
      #   env:
      #     TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
      #     TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      #   run: |
      #     python setup.py sdist bdist_wheel
      #     twine upload dist/*

      - name: 'âœï¸ Generate full changelog'
        id: generate-full-changelog
        uses: ./
        with:
          token: ${{ secrets.GH_TOKEN }}
          headerLabel: '# ğŸ“‘ Changelog'
          breakingLabel: '### ğŸ’¥ Breaking'
          enhancementLabel: '### ğŸš€ Enhancements'
          bugsLabel: '### ğŸ› Bug fixes'
          deprecatedLabel: '### âš ï¸ Deprecations'
          removedLabel: '### ğŸ”¥ Removals'
          securityLabel: '### ğŸ›¡ï¸ Security'
          issuesLabel: '### ğŸ“ Other issues'
          prLabel: '### ğŸ“ Other pull requests'
          addSections: '{"documentation":{"prefix":"### ğŸ“– Documentation","labels":["docs","documentation"]},"tests":{"prefix":"### âœ… Testing","labels":["test","tests"]}}'
          issues: true
          issuesWoLabels: true
          pullRequests: true
          prWoLabels: true
          author: true
          unreleased: true
          compareLink: true
          stripGeneratorNotice: true
          verbose: true

      - name: 'ğŸ–¨ï¸ Print changelog to console'
        run: cat CHANGELOG.md

      - name: 'ğŸ“¤ commit'
        uses: stefanzweifel/git-auto-commit-action@v5

      # åˆ›å»ºrelease
      # - name: Create Release
      #   id: create_release
      #   continue-on-error: true
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #   with:
      #     tag_name: v${{ steps.get_version.outputs.version }}
      #     release_name: v${{ steps.get_version.outputs.version }}
      #     body: ${{ steps.gen_release_notes.outputs.result }}
      #     draft: false
      #     prerelease: false
